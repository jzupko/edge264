#define TRACE 1
#include "edge264.c"

#define RED   "\x1b[31m"
#define GREEN "\x1b[32m"
#define RESET "\x1b[0m"

void test4x4_8bit(int mode, const char *name, const uint8_t result[16]) {
	ctx->PredMode[0] = mode;
	printf("%s: ", name);
	decode_samples();
	
	uint8_t *p = ctx->plane;
	if (memcmp(p, result, 4) == 0 && memcmp(p + 32, result + 4, 4) == 0 &&
		memcmp(p + 64, result + 8, 4) == 0 && memcmp(p + 96, result + 12, 4) == 0) {
		puts(GREEN "PASS" RESET);
	} else {
		puts(RED "FAIL" RESET);
		for (int r = -1; r < 4; r++) {
			for (int c = -1; c < 4; c++)
				printf("%3d ", p[32 * r + c]);
			putchar('\n');
		}
	}
}

void test8x8_8bit(int mode, const char *name, const uint8_t result[64]) {
	ctx->PredMode[0] = mode;
	printf("%s: ", name);
	decode_samples();
	
	uint8_t *p = ctx->plane;
	if (memcmp(p, result, 8) == 0 && memcmp(p + 32, result + 8, 8) == 0 &&
		memcmp(p + 64, result + 16, 8) == 0 && memcmp(p + 96, result + 24, 8) == 0 &&
		memcmp(p + 128, result + 32, 8) == 0 && memcmp(p + 160, result + 40, 8) == 0 &&
		memcmp(p + 192, result + 48, 8) == 0 && memcmp(p + 224, result + 56, 8) == 0) {
		puts(GREEN "PASS" RESET);
	} else {
		puts(RED "FAIL" RESET);
		for (int r = -1; r < 8; r++) {
			for (int c = -1; c < 8; c++)
				printf("%3d ", p[32 * r + c]);
			putchar('\n');
		}
	}
}



int main() {
	uint8_t *p = malloc(64 * 17) + 96;
	for (int i = 8; i-- > 0;)
		p[32 * i - 1] = 156 - i * 4;
	for (int i = -1; i < 16; i++)
		p[i - 32] = 164 + i * 4;
	Edge264_ctx c = {
		.plane = p,
		.clip = (v8hi){255, 255, 255, 255, 255, 255, 255, 255},
		.stride = 32,
	};
	ctx = &c;
	
#define test(str, ...) test4x4_8bit(str, #str , (uint8_t[]){__VA_ARGS__})
	test(VERTICAL_4x4, 164, 168, 172, 176, 164, 168, 172, 176, 164, 168, 172, 176, 164, 168, 172, 176);
	test(HORIZONTAL_4x4, 156, 156, 156, 156, 152, 152, 152, 152, 148, 148, 148, 148, 144, 144, 144, 144);
	test(DC_4x4, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160);
	test(DC_A_4x4, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170);
	test(DC_B_4x4, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150);
	test(DC_AB_4x4, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128);
	test(DIAGONAL_DOWN_LEFT_4x4, 168, 172, 176, 180, 172, 176, 180, 184, 176, 180, 184, 188, 180, 184, 188, 191);
	test(DIAGONAL_DOWN_LEFT_C_4x4, 168, 172, 175, 176, 172, 175, 176, 176, 175, 176, 176, 176, 176, 176, 176, 176);
	test(DIAGONAL_DOWN_RIGHT_4x4, 160, 164, 168, 172, 156, 160, 164, 168, 152, 156, 160, 164, 148, 152, 156, 160);
	test(VERTICAL_RIGHT_4x4, 162, 166, 170, 174, 160, 164, 168, 172, 156, 162, 166, 170, 152, 160, 164, 168);
	test(HORIZONTAL_DOWN_4x4, 158, 160, 164, 168, 154, 156, 158, 160, 150, 152, 154, 156, 146, 148, 150, 152);
	test(VERTICAL_LEFT_4x4, 166, 170, 174, 178, 168, 172, 176, 180, 170, 174, 178, 182, 172, 176, 180, 184);
	test(VERTICAL_LEFT_C_4x4, 166, 170, 174, 176, 168, 172, 175, 176, 170, 174, 176, 176, 172, 175, 176, 176);
	test(HORIZONTAL_UP_4x4, 154, 152, 150, 148, 150, 148, 146, 145, 146, 145, 144, 144, 144, 144, 144, 144);
	putchar('\n');
#undef test

#define test(str, ...) test8x8_8bit(str, #str , (uint8_t[]){__VA_ARGS__})
	test(VERTICAL_8x8, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192);
	test(VERTICAL_C_8x8, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191);
	test(VERTICAL_D_8x8, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192);
	test(VERTICAL_CD_8x8, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191);
	test(HORIZONTAL_8x8, 156, 156, 156, 156, 156, 156, 156, 156, 152, 152, 152, 152, 152, 152, 152, 152, 148, 148, 148, 148, 148, 148, 148, 148, 144, 144, 144, 144, 144, 144, 144, 144, 140, 140, 140, 140, 140, 140, 140, 140, 136, 136, 136, 136, 136, 136, 136, 136, 132, 132, 132, 132, 132, 132, 132, 132, 129, 129, 129, 129, 129, 129, 129, 129);
	test(HORIZONTAL_D_8x8, 155, 155, 155, 155, 155, 155, 155, 155, 152, 152, 152, 152, 152, 152, 152, 152, 148, 148, 148, 148, 148, 148, 148, 148, 144, 144, 144, 144, 144, 144, 144, 144, 140, 140, 140, 140, 140, 140, 140, 140, 136, 136, 136, 136, 136, 136, 136, 136, 132, 132, 132, 132, 132, 132, 132, 132, 129, 129, 129, 129, 129, 129, 129, 129);
	test(DC_8x8, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160);
	test(DC_C_8x8, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160);
	test(DC_D_8x8, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160);
	test(DC_CD_8x8, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160);
	
#undef test
}
