#define TRACE 1
#include "edge264.c"

#define RED   "\x1b[31m"
#define GREEN "\x1b[32m"
#define RESET "\x1b[0m"

void test4x4_8bit(int mode, const char *name, const uint8_t result[16]) {
	ctx->PredMode[0] = mode;
	printf("%s: ", name);
	decode_samples();
	
	uint8_t *p = ctx->plane;
	if (memcmp(p, result, 4) == 0 && memcmp(p + 32, result + 4, 4) == 0 &&
		memcmp(p + 64, result + 8, 4) == 0 && memcmp(p + 96, result + 12, 4) == 0) {
		puts(GREEN "PASS" RESET);
	} else {
		puts(RED "FAIL" RESET);
		for (int r = -1; r < 4; r++) {
			for (int c = -1; c < 4; c++)
				printf("%3d ", p[32 * r + c]);
			putchar('\n');
		}
	}
}

void test8x8_8bit(int mode, const char *name, const uint8_t result[64]) {
	ctx->PredMode[0] = mode;
	printf("%s: ", name);
	decode_samples();
	
	uint8_t *p = ctx->plane;
	if (memcmp(p, result, 8) == 0 && memcmp(p + 32, result + 8, 8) == 0 &&
		memcmp(p + 64, result + 16, 8) == 0 && memcmp(p + 96, result + 24, 8) == 0 &&
		memcmp(p + 128, result + 32, 8) == 0 && memcmp(p + 160, result + 40, 8) == 0 &&
		memcmp(p + 192, result + 48, 8) == 0 && memcmp(p + 224, result + 56, 8) == 0) {
		puts(GREEN "PASS" RESET);
	} else {
		puts(RED "FAIL" RESET);
		for (int r = -1; r < 8; r++) {
			for (int c = -1; c < 8; c++)
				printf("%3d ", p[32 * r + c]);
			putchar('\n');
		}
	}
}



int main() {
	uint8_t *p = malloc(64 * 17) + 96;
	for (int i = 8; i-- > 0;)
		p[32 * i - 1] = 156 - i * 4;
	for (int i = -1; i < 16; i++)
		p[i - 32] = 164 + i * 4;
	Edge264_ctx c = {
		.plane = p,
		.clip = (v8hi){255, 255, 255, 255, 255, 255, 255, 255},
		.stride = 32,
	};
	ctx = &c;
	
#define test(str, ...) test4x4_8bit(str, #str , (uint8_t[]){__VA_ARGS__})
	test(VERTICAL_4x4, 164, 168, 172, 176, 164, 168, 172, 176, 164, 168, 172, 176, 164, 168, 172, 176);
	test(HORIZONTAL_4x4, 156, 156, 156, 156, 152, 152, 152, 152, 148, 148, 148, 148, 144, 144, 144, 144);
	test(DC_4x4, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160);
	test(DC_4x4_A, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170, 170);
	test(DC_4x4_B, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150);
	test(DC_4x4_AB, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128);
	test(DIAGONAL_DOWN_LEFT_4x4, 168, 172, 176, 180, 172, 176, 180, 184, 176, 180, 184, 188, 180, 184, 188, 191);
	test(DIAGONAL_DOWN_LEFT_4x4_C, 168, 172, 175, 176, 172, 175, 176, 176, 175, 176, 176, 176, 176, 176, 176, 176);
	test(DIAGONAL_DOWN_RIGHT_4x4, 160, 164, 168, 172, 156, 160, 164, 168, 152, 156, 160, 164, 148, 152, 156, 160);
	test(VERTICAL_RIGHT_4x4, 162, 166, 170, 174, 160, 164, 168, 172, 156, 162, 166, 170, 152, 160, 164, 168);
	test(HORIZONTAL_DOWN_4x4, 158, 160, 164, 168, 154, 156, 158, 160, 150, 152, 154, 156, 146, 148, 150, 152);
	test(VERTICAL_LEFT_4x4, 166, 170, 174, 178, 168, 172, 176, 180, 170, 174, 178, 182, 172, 176, 180, 184);
	test(VERTICAL_LEFT_4x4_C, 166, 170, 174, 176, 168, 172, 175, 176, 170, 174, 176, 176, 172, 175, 176, 176);
	test(HORIZONTAL_UP_4x4, 154, 152, 150, 148, 150, 148, 146, 145, 146, 145, 144, 144, 144, 144, 144, 144);
	putchar('\n');
#undef test

#define test(str, ...) test8x8_8bit(str, #str , (uint8_t[]){__VA_ARGS__})
	test(VERTICAL_8x8, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192, 164, 168, 172, 176, 180, 184, 188, 192);
	test(VERTICAL_8x8_C, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191, 164, 168, 172, 176, 180, 184, 188, 191);
	test(VERTICAL_8x8_D, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192, 165, 168, 172, 176, 180, 184, 188, 192);
	test(VERTICAL_8x8_CD, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191, 165, 168, 172, 176, 180, 184, 188, 191);
	test(HORIZONTAL_8x8, 156, 156, 156, 156, 156, 156, 156, 156, 152, 152, 152, 152, 152, 152, 152, 152, 148, 148, 148, 148, 148, 148, 148, 148, 144, 144, 144, 144, 144, 144, 144, 144, 140, 140, 140, 140, 140, 140, 140, 140, 136, 136, 136, 136, 136, 136, 136, 136, 132, 132, 132, 132, 132, 132, 132, 132, 129, 129, 129, 129, 129, 129, 129, 129);
	test(HORIZONTAL_8x8_D, 155, 155, 155, 155, 155, 155, 155, 155, 152, 152, 152, 152, 152, 152, 152, 152, 148, 148, 148, 148, 148, 148, 148, 148, 144, 144, 144, 144, 144, 144, 144, 144, 140, 140, 140, 140, 140, 140, 140, 140, 136, 136, 136, 136, 136, 136, 136, 136, 132, 132, 132, 132, 132, 132, 132, 132, 129, 129, 129, 129, 129, 129, 129, 129);
	test(DC_8x8, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160);
	test(DC_8x8_C, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160);
	test(DC_8x8_D, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160);
	test(DC_8x8_CD, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160);
	test(DC_8x8_A, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178);
	test(DC_8x8_AC, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178);
	test(DC_8x8_AD, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178);
	test(DC_8x8_ACD, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178, 178);
	test(DC_8x8_B, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142);
	test(DC_8x8_BD, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142, 142);
	test(DC_8x8_AB, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128);
	test(DIAGONAL_DOWN_LEFT_8x8, 168, 172, 176, 180, 184, 188, 192, 196, 172, 176, 180, 184, 188, 192, 196, 200, 176, 180, 184, 188, 192, 196, 200, 204, 180, 184, 188, 192, 196, 200, 204, 208, 184, 188, 192, 196, 200, 204, 208, 212, 188, 192, 196, 200, 204, 208, 212, 216, 192, 196, 200, 204, 208, 212, 216, 220, 196, 200, 204, 208, 212, 216, 220, 222);
	test(DIAGONAL_DOWN_LEFT_8x8_C, 168, 172, 176, 180, 184, 188, 191, 192, 172, 176, 180, 184, 188, 191, 192, 192, 176, 180, 184, 188, 191, 192, 192, 192, 180, 184, 188, 191, 192, 192, 192, 192, 184, 188, 191, 192, 192, 192, 192, 192, 188, 191, 192, 192, 192, 192, 192, 192, 191, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192);
	test(DIAGONAL_DOWN_LEFT_8x8_D, 168, 172, 176, 180, 184, 188, 192, 196, 172, 176, 180, 184, 188, 192, 196, 200, 176, 180, 184, 188, 192, 196, 200, 204, 180, 184, 188, 192, 196, 200, 204, 208, 184, 188, 192, 196, 200, 204, 208, 212, 188, 192, 196, 200, 204, 208, 212, 216, 192, 196, 200, 204, 208, 212, 216, 220, 196, 200, 204, 208, 212, 216, 220, 222);
	test(DIAGONAL_DOWN_LEFT_8x8_CD, 168, 172, 176, 180, 184, 188, 191, 192, 172, 176, 180, 184, 188, 191, 192, 192, 176, 180, 184, 188, 191, 192, 192, 192, 180, 184, 188, 191, 192, 192, 192, 192, 184, 188, 191, 192, 192, 192, 192, 192, 188, 191, 192, 192, 192, 192, 192, 192, 191, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192, 192);
	test(DIAGONAL_DOWN_RIGHT_8x8, 160, 164, 168, 172, 176, 180, 184, 188, 156, 160, 164, 168, 172, 176, 180, 184, 152, 156, 160, 164, 168, 172, 176, 180, 148, 152, 156, 160, 164, 168, 172, 176, 144, 148, 152, 156, 160, 164, 168, 172, 140, 144, 148, 152, 156, 160, 164, 168, 136, 140, 144, 148, 152, 156, 160, 164, 132, 136, 140, 144, 148, 152, 156, 160);
	test(DIAGONAL_DOWN_RIGHT_8x8_C, 160, 164, 168, 172, 176, 180, 184, 188, 156, 160, 164, 168, 172, 176, 180, 184, 152, 156, 160, 164, 168, 172, 176, 180, 148, 152, 156, 160, 164, 168, 172, 176, 144, 148, 152, 156, 160, 164, 168, 172, 140, 144, 148, 152, 156, 160, 164, 168, 136, 140, 144, 148, 152, 156, 160, 164, 132, 136, 140, 144, 148, 152, 156, 160);
	test(VERTICAL_RIGHT_8x8, 162, 166, 170, 174, 178, 182, 186, 190, 160, 164, 168, 172, 176, 180, 184, 188, 156, 162, 166, 170, 174, 178, 182, 186, 152, 160, 164, 168, 172, 176, 180, 184, 148, 156, 162, 166, 170, 174, 178, 182, 144, 152, 160, 164, 168, 172, 176, 180, 140, 148, 156, 162, 166, 170, 174, 178, 136, 144, 152, 160, 164, 168, 172, 176);
	test(VERTICAL_RIGHT_8x8_C, 162, 166, 170, 174, 178, 182, 186, 190, 160, 164, 168, 172, 176, 180, 184, 188, 156, 162, 166, 170, 174, 178, 182, 186, 152, 160, 164, 168, 172, 176, 180, 184, 148, 156, 162, 166, 170, 174, 178, 182, 144, 152, 160, 164, 168, 172, 176, 180, 140, 148, 156, 162, 166, 170, 174, 178, 136, 144, 152, 160, 164, 168, 172, 176);
	test(HORIZONTAL_DOWN_8x8, 158, 160, 164, 168, 172, 176, 180, 184, 154, 156, 158, 160, 164, 168, 172, 176, 150, 152, 154, 156, 158, 160, 164, 168, 146, 148, 150, 152, 154, 156, 158, 160, 142, 144, 146, 148, 150, 152, 154, 156, 138, 140, 142, 144, 146, 148, 150, 152, 134, 136, 138, 140, 142, 144, 146, 148, 131, 132, 134, 136, 138, 140, 142, 144);
	test(VERTICAL_LEFT_8x8, 166, 170, 174, 178, 182, 186, 190, 194, 168, 172, 176, 180, 184, 188, 192, 196, 170, 174, 178, 182, 186, 190, 194, 198, 172, 176, 180, 184, 188, 192, 196, 200, 174, 178, 182, 186, 190, 194, 198, 202, 176, 180, 184, 188, 192, 196, 200, 204, 178, 182, 186, 190, 194, 198, 202, 206, 180, 184, 188, 192, 196, 200, 204, 208);
	test(VERTICAL_LEFT_8x8_C, 166, 170, 174, 178, 182, 186, 190, 192, 168, 172, 176, 180, 184, 188, 191, 192, 170, 174, 178, 182, 186, 190, 192, 192, 172, 176, 180, 184, 188, 191, 192, 192, 174, 178, 182, 186, 190, 192, 192, 192, 176, 180, 184, 188, 191, 192, 192, 192, 178, 182, 186, 190, 192, 192, 192, 192, 180, 184, 188, 191, 192, 192, 192, 192);
	test(VERTICAL_LEFT_8x8_D, 167, 170, 174, 178, 182, 186, 190, 194, 168, 172, 176, 180, 184, 188, 192, 196, 170, 174, 178, 182, 186, 190, 194, 198, 172, 176, 180, 184, 188, 192, 196, 200, 174, 178, 182, 186, 190, 194, 198, 202, 176, 180, 184, 188, 192, 196, 200, 204, 178, 182, 186, 190, 194, 198, 202, 206, 180, 184, 188, 192, 196, 200, 204, 208);
	test(VERTICAL_LEFT_8x8_CD, 167, 170, 174, 178, 182, 186, 190, 192, 168, 172, 176, 180, 184, 188, 191, 192, 170, 174, 178, 182, 186, 190, 192, 192, 172, 176, 180, 184, 188, 191, 192, 192, 174, 178, 182, 186, 190, 192, 192, 192, 176, 180, 184, 188, 191, 192, 192, 192, 178, 182, 186, 190, 192, 192, 192, 192, 180, 184, 188, 191, 192, 192, 192, 192);
	test(HORIZONTAL_UP_8x8, 154, 152, 150, 148, 146, 144, 142, 140, 150, 148, 146, 144, 142, 140, 138, 136, 146, 144, 142, 140, 138, 136, 134, 132, 142, 140, 138, 136, 134, 132, 131, 130, 138, 136, 134, 132, 131, 130, 129, 129, 134, 132, 131, 130, 129, 129, 129, 129, 131, 130, 129, 129, 129, 129, 129, 129, 129, 129, 129, 129, 129, 129, 129, 129);
#undef test
}


